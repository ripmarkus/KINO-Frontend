{"version":3,"file":"mutation-observer.js","sourceRoot":"","sources":["../../../../src/components/common/controllers/mutation-observer.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ReactiveController, ReactiveControllerHost } from 'lit';\nimport { isElement } from '../util.js';\n\n/** @ignore */\nexport interface MutationControllerConfig<T extends Node = Node> {\n  /** The callback function to run when a mutation occurs. */\n  callback: MutationControllerCallback<T>;\n  /** The underlying mutation observer configuration parameters. */\n  config: MutationObserverInit;\n  /**\n   * The element to observe.\n   * If left out, the observer will listen on the host component itself.\n   */\n  target?: Element;\n  /**\n   * A filter configuration.\n   * See {@link MutationControllerFilter|this} for additional information.\n   */\n  filter?: MutationControllerFilter<T>;\n}\n\ntype MutationControllerCallback<T extends Node = Node> = (\n  params: MutationControllerParams<T>\n) => unknown;\n\n/**\n * Filter configuration to return elements that either match\n * an array of selector strings or a predicate function.\n */\ntype MutationControllerFilter<T extends Node = Node> =\n  | string[]\n  | ((node: T) => boolean);\n\ntype MutationDOMChange<T extends Node = Node> = {\n  /** The parent of the added/removed element. */\n  target: Element;\n  /** The added/removed element. */\n  node: T;\n};\n\ntype MutationAttributeChange<T extends Node = Node> = {\n  /** The host element of the changed attribute. */\n  node: T;\n  /** The changed attribute name. */\n  attributeName: string | null;\n};\n\ntype MutationChange<T extends Node = Node> = {\n  /** Elements that have attribute(s) changes. */\n  attributes: MutationAttributeChange<T>[];\n  /** Elements that have been added. */\n  added: MutationDOMChange<T>[];\n  /** Elements that have been removed. */\n  removed: MutationDOMChange<T>[];\n};\n\nexport type MutationControllerParams<T extends Node = Node> = {\n  /** The original mutation records from the underlying observer. */\n  records: MutationRecord[];\n  /** The aggregated changes. */\n  changes: MutationChange<T>;\n  /** The observer controller instance. */\n  observer: MutationController<T>;\n};\n\nfunction applyNodeFilter<T extends Node = Node>(\n  nodes: T[],\n  predicate?: MutationControllerFilter<T>\n): T[] {\n  if (!predicate) {\n    return nodes;\n  }\n\n  return Array.isArray(predicate)\n    ? nodes.filter(\n        (node) =>\n          isElement(node) &&\n          predicate.some((selector) => node.matches(selector))\n      )\n    : nodes.filter(predicate);\n}\n\nclass MutationController<T extends Node = Node> implements ReactiveController {\n  private readonly _host: ReactiveControllerHost & Element;\n  private readonly _observer: MutationObserver;\n  private readonly _target: Element;\n  private readonly _config: MutationObserverInit;\n  private readonly _callback: MutationControllerCallback<T>;\n  private readonly _filter?: MutationControllerFilter<T>;\n\n  constructor(\n    host: ReactiveControllerHost & Element,\n    options: MutationControllerConfig<T>\n  ) {\n    this._host = host;\n    this._callback = options.callback;\n    this._config = options.config;\n    this._target = options.target ?? this._host;\n    this._filter = options.filter;\n\n    this._observer = new MutationObserver((records) => {\n      this.disconnect();\n      this._callback.call(this._host, this._process(records));\n      this.observe();\n    });\n\n    host.addController(this);\n  }\n\n  /** @internal */\n  public hostConnected(): void {\n    this.observe();\n  }\n\n  /** @internal */\n  public hostDisconnected(): void {\n    this.disconnect();\n  }\n\n  private _process(records: MutationRecord[]): MutationControllerParams<T> {\n    const predicate = this._filter;\n    const changes: MutationChange<T> = {\n      attributes: [],\n      added: [],\n      removed: [],\n    };\n\n    for (const record of records) {\n      const { type, target, attributeName, addedNodes, removedNodes } = record;\n\n      if (type === 'attributes') {\n        changes.attributes.push(\n          ...applyNodeFilter([target as T], predicate).map((node) => ({\n            node,\n            attributeName,\n          }))\n        );\n      } else if (type === 'childList') {\n        changes.added.push(\n          ...applyNodeFilter([...addedNodes] as T[], predicate).map((node) => ({\n            target: target as Element,\n            node,\n          }))\n        );\n        changes.removed.push(\n          ...applyNodeFilter([...removedNodes] as T[], predicate).map(\n            (node) => ({\n              target: target as Element,\n              node,\n            })\n          )\n        );\n      }\n    }\n\n    return { records, changes, observer: this };\n  }\n\n  /**\n   * Begin receiving notifications of changes to the DOM based\n   * on the configured {@link MutationControllerConfig.target|target} and observer {@link MutationControllerConfig.config|options}.\n   */\n  public observe(): void {\n    this._observer.observe(this._target, this._config);\n  }\n\n  /** Stop watching for mutations. */\n  public disconnect(): void {\n    this._observer.disconnect();\n  }\n}\n\n/**\n * Creates and attaches a mutation controller with `config` to the passed in `host`.\n *\n * Automatically starts/stops observing for mutation changes\n * in the respective component connect/disconnect callbacks.\n *\n * The mutation observer is disconnected before invoking the passed in callback and re-attached\n * after that in order to not loop itself in endless stream of changes.\n */\nexport function createMutationController<T extends Node = Node>(\n  host: ReactiveControllerHost & Element,\n  config: MutationControllerConfig<T>\n): MutationController<T> {\n  return new MutationController(host, config);\n}\n"]}