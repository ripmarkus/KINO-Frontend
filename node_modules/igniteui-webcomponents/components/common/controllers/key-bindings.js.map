{"version":3,"file":"key-bindings.js","sourceRoot":"","sources":["../../../../src/components/common/controllers/key-bindings.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ReactiveController, ReactiveControllerHost } from 'lit';\nimport type { Ref } from 'lit/directives/ref.js';\nimport { createAbortHandle } from '../abort-handler.js';\nimport { asArray, findElementFromEventPath, isFunction } from '../util.js';\n\n//#region Keys and modifiers\n\n/* Common keys */\nexport const arrowLeft = 'ArrowLeft' as const;\nexport const arrowRight = 'ArrowRight' as const;\nexport const arrowUp = 'ArrowUp' as const;\nexport const arrowDown = 'ArrowDown' as const;\nexport const enterKey = 'Enter' as const;\nexport const spaceBar = ' ' as const;\nexport const escapeKey = 'Escape' as const;\nexport const homeKey = 'Home' as const;\nexport const endKey = 'End' as const;\nexport const pageUpKey = 'PageUp' as const;\nexport const pageDownKey = 'PageDown' as const;\nexport const tabKey = 'Tab' as const;\n\n/* Modifiers */\nexport const altKey = 'Alt' as const;\nexport const ctrlKey = 'Ctrl' as const;\nexport const metaKey = 'Meta' as const;\nexport const shiftKey = 'Shift' as const;\n\n//#endregion\n\n//#region Types\n\n/* Types */\ntype KeyBindingHandler = (event: KeyboardEvent) => void;\ntype KeyBindingObserverCleanup = { unsubscribe: () => void };\n\n/**\n * Whether the current event should be ignored by the controller.\n *\n * @param node - The event target\n * @param event - The event object\n *\n * When `true` is returned, the current event is ignored.\n */\ntype KeyBindingSkipCallback = (node: Element, event: KeyboardEvent) => boolean;\n\n/**\n * The event type which will trigger the bound handler.\n *\n * @remarks\n * `keydownRepeat` is similar to `keydown` with the exception\n * that after the handler is invoked the pressed state of the key is reset\n * in the controller.\n */\ntype KeyBindingTrigger = 'keydown' | 'keyup' | 'keydownRepeat';\n\n/**\n * Configuration object for the controller.\n * @ignore\n */\ninterface KeyBindingControllerOptions {\n  /**\n   * By default, the controller listens for keypress events in the context of the host element.\n   * If you pass a `ref`, you can limit the observation to a certain DOM part of the host scope.\n   */\n  ref?: Ref;\n  /**\n   * Option to ignore key press events.\n   *\n   * If passed an array of CSS selectors, it will ignore key presses originating from elements in the event composed path\n   * that match one of the selectors.\n   * Otherwise you can pass a {@link KeyBindingSkipCallback} function.\n   *\n   * Defaults to `['input', 'textarea', 'select']`.\n   *\n   * @example\n   * ```ts\n   * {\n   *  // Skip events originating from elements with `readonly` attribute\n   *  skip: ['[readonly]']\n   * }\n   * ...\n   * {\n   * // Same as above but with a callback\n   *  skip: (node: Element) => node.hasAttribute('readonly')\n   * }\n   * ```\n   */\n  skip?: string[] | KeyBindingSkipCallback;\n  /**\n   * A set of KeyBindingOptions configuration which is applied to every handler\n   * that is added to the controller.\n   *\n   * Any additional KeyBindingOptions values passed when `set` is called\n   * will be merged with `bindingDefaults`.\n   */\n  bindingDefaults?: KeyBindingOptions;\n}\n\n/**\n * Configuration object for customizing the behavior of\n * the registered handler.\n */\ninterface KeyBindingOptions {\n  /**\n   * The event type(s) on which the handler will be invoked.\n   *\n   * Defaults to `keydown` if not set.\n   */\n  triggers?: KeyBindingTrigger[];\n  /**\n   * Whether to call `preventDefault` on the target event before the handler is invoked.\n   */\n  preventDefault?: boolean;\n  /**\n   * Whether to call `stopPropagation` on the target event before the handler is invoked.\n   */\n  stopPropagation?: boolean;\n}\n\ninterface KeyBinding {\n  keys: string[];\n  handler: KeyBindingHandler;\n  options?: KeyBindingOptions;\n  modifiers: string[];\n}\n\n//#endregion\n\n//#region Internal functions and constants\n\nconst Modifiers: Map<string, string> = new Map([\n  [altKey.toLowerCase(), altKey.toLowerCase()],\n  [ctrlKey.toLowerCase(), ctrlKey.toLowerCase()],\n  [metaKey.toLowerCase(), metaKey.toLowerCase()],\n  [shiftKey.toLowerCase(), shiftKey.toLowerCase()],\n]);\n\nconst ALL_MODIFIER_VALUES = Array.from(Modifiers.values()).sort();\n\nfunction normalizeKeys(keys: string | string[]): string[] {\n  return asArray(keys).map((key) => key.toLowerCase());\n}\n\nfunction isKeydown(event: Event): boolean {\n  return event.type === 'keydown';\n}\n\nfunction isKeyup(event: Event): boolean {\n  return event.type === 'keyup';\n}\n\nfunction isKeydownTrigger(triggers?: KeyBindingTrigger[]): boolean {\n  return triggers\n    ? triggers.includes('keydown') || isKeydownRepeatTrigger(triggers)\n    : false;\n}\n\nfunction isKeyupTrigger(triggers?: KeyBindingTrigger[]): boolean {\n  return triggers ? triggers.includes('keyup') : false;\n}\n\nfunction isKeydownRepeatTrigger(triggers?: KeyBindingTrigger[]): boolean {\n  return triggers ? triggers.includes('keydownRepeat') : false;\n}\n\nfunction createCombinationKey(keys: string[], modifiers: string[]): string {\n  const sortedKeys = keys.toSorted();\n  const sortedModifiers = ALL_MODIFIER_VALUES.filter((mod) =>\n    modifiers.includes(mod)\n  ).sort();\n\n  return sortedModifiers.concat(sortedKeys).join('+');\n}\n\n//#endregion\n\nclass KeyBindingController implements ReactiveController {\n  //#region Private properties and state\n\n  private static readonly _defaultOptions: KeyBindingControllerOptions = {\n    skip: ['input', 'textarea', 'select'],\n  };\n\n  private readonly _host: ReactiveControllerHost & Element;\n  private readonly _ref?: Ref;\n  private readonly _abortHandle = createAbortHandle();\n\n  private readonly _bindings = new Map<string, KeyBinding>();\n  private readonly _allowedKeys = new Set<string>();\n  private readonly _pressedKeys = new Set<string>();\n\n  private readonly _options: KeyBindingControllerOptions;\n  private readonly _skipSelector: string | undefined;\n\n  private _observedElement?: Element;\n\n  private get _element(): Element {\n    if (this._observedElement) {\n      return this._observedElement;\n    }\n    return this._ref?.value || this._host;\n  }\n\n  //#endregion\n\n  constructor(\n    host: ReactiveControllerHost & Element,\n    options?: KeyBindingControllerOptions\n  ) {\n    this._host = host;\n    this._ref = options?.ref;\n    this._options = { ...KeyBindingController._defaultOptions, ...options };\n\n    if (Array.isArray(this._options.skip)) {\n      this._skipSelector = this._options.skip.join(',');\n    }\n\n    host.addController(this);\n  }\n\n  //#region Private API\n\n  /**\n   * Checks and executes any event modifiers that are present in the matched binding.\n   */\n  private _applyEventModifiers(\n    binding: KeyBinding,\n    event: KeyboardEvent\n  ): void {\n    if (binding.options?.preventDefault) {\n      event.preventDefault();\n    }\n\n    if (binding.options?.stopPropagation) {\n      event.stopPropagation();\n    }\n  }\n\n  private _bindingMatches(binding: KeyBinding, event: KeyboardEvent): boolean {\n    const triggers = binding.options?.triggers ?? ['keydown'];\n\n    if (isKeydown(event) && isKeydownTrigger(triggers)) {\n      return true;\n    }\n\n    if (isKeyup(event) && isKeyupTrigger(triggers)) {\n      return true;\n    }\n\n    return false;\n  }\n\n  private _shouldSkip(event: KeyboardEvent): boolean {\n    const skip = this._options?.skip;\n\n    if (!this._allowedKeys.has(event.key.toLowerCase())) {\n      return true;\n    }\n\n    if (!findElementFromEventPath((e) => e === this._element, event)) {\n      return true;\n    }\n\n    if (Array.isArray(skip)) {\n      if (!this._skipSelector) {\n        return false;\n      }\n\n      return Boolean(findElementFromEventPath(this._skipSelector, event));\n    }\n\n    if (isFunction(skip)) {\n      return skip.call(this._host, event.target as Element, event);\n    }\n\n    return false;\n  }\n\n  //#endregion\n\n  //#region Controller specific handlers\n\n  /** @internal */\n  public hostConnected(): void {\n    const { signal } = this._abortHandle;\n    this._host.addEventListener('keyup', this, { signal });\n    this._host.addEventListener('keydown', this, { signal });\n  }\n\n  /** @internal */\n  public hostDisconnected(): void {\n    this._abortHandle.abort();\n  }\n\n  /** @internal */\n  public handleEvent(event: KeyboardEvent): void {\n    if (this._shouldSkip(event)) {\n      return;\n    }\n\n    const key = event.key.toLowerCase();\n\n    if (!Modifiers.has(key)) {\n      this._pressedKeys.add(key);\n    }\n\n    const activeModifiers = ALL_MODIFIER_VALUES.filter(\n      (mod) => event[`${mod}Key` as keyof KeyboardEvent]\n    );\n\n    const combination = createCombinationKey(\n      Array.from(this._pressedKeys),\n      activeModifiers\n    );\n\n    const binding = this._bindings.get(combination);\n\n    if (binding && this._bindingMatches(binding, event)) {\n      this._applyEventModifiers(binding, event);\n      binding.handler.call(this._host, event);\n\n      if (isKeydownRepeatTrigger(binding.options?.triggers)) {\n        this._pressedKeys.delete(key);\n      }\n    }\n\n    if (isKeyup(event) && !Modifiers.has(key)) {\n      this._pressedKeys.delete(key);\n    }\n  }\n\n  //#endregion\n\n  //#region Public API\n\n  /**\n   * Registers a keybinding handler.\n   */\n  public set(\n    key: string | string[],\n    handler: KeyBindingHandler,\n    bindingOptions?: KeyBindingOptions\n  ) {\n    const { keys, modifiers } = parseKeys(key);\n    const combination = createCombinationKey(keys, modifiers);\n    const options = { ...this._options?.bindingDefaults, ...bindingOptions };\n\n    for (const each of [...keys, ...modifiers]) {\n      this._allowedKeys.add(each);\n    }\n\n    this._bindings.set(combination, { keys, handler, options, modifiers });\n\n    return this;\n  }\n\n  /**\n   * Register a handler function which is called when the target receives a key\n   * which \"activates\" it.\n   *\n   * In the browser context this is usually either an Enter and Space bar keypress.\n   */\n  public setActivateHandler(\n    handler: KeyBindingHandler,\n    options?: KeyBindingOptions\n  ) {\n    this.set(enterKey, handler, options);\n    this.set(spaceBar, handler, options);\n\n    return this;\n  }\n\n  /**\n   * Sets the controller to listen for keyboard events on an arbitrary `element` in the page context.\n   * All the configuration and event handlers are applied as well.\n   *\n   * Returns an object with an `unsubscribe` function which should be called when the observing of keyboard\n   * events on the `element` should cease.\n   */\n  public observeElement(element: Element): KeyBindingObserverCleanup {\n    element.addEventListener('keydown', this);\n    element.addEventListener('keyup', this);\n    this._observedElement = element;\n\n    return {\n      unsubscribe: () => {\n        this._observedElement?.removeEventListener('keydown', this);\n        this._observedElement?.removeEventListener('keyup', this);\n        this._observedElement = undefined;\n      },\n    };\n  }\n\n  //#endregion\n}\n\n/** @internal */\nexport function parseKeys(keys: string | string[]) {\n  const normalizedKeys = normalizeKeys(keys);\n  return {\n    keys: normalizedKeys.filter((key) => !Modifiers.has(key)),\n    modifiers: normalizedKeys.filter((key) => Modifiers.has(key)),\n  };\n}\n\n/**\n * Creates a keybinding controller and adds to it to the passed `element`\n * with the provided `options`.\n */\nexport function addKeybindings(\n  element: ReactiveControllerHost & Element,\n  options?: KeyBindingControllerOptions\n): KeyBindingController {\n  return new KeyBindingController(element, options);\n}\n\nexport type {\n  KeyBindingHandler,\n  KeyBindingObserverCleanup,\n  KeyBindingSkipCallback,\n  KeyBindingTrigger,\n  KeyBindingControllerOptions,\n  KeyBindingOptions,\n  KeyBindingController,\n};\n"]}